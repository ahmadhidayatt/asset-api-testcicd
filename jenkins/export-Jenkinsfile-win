pipeline {
  agent any

  options {
    timestamps()
    timeout(time: 60, unit: 'MINUTES')
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '30'))
  }

  stages {

    stage('Checkout SCM') {
      steps {
        checkout scm
      }
    }

    stage('Load Properties') {
      steps {
        script {
          def props = readProperties file: 'jenkins/jenkins.properties'

          env.API_PROJECT         = props['api_project']?.trim()
          env.APIGATEWAY_URL      = props['apigateway_url']?.trim()
          env.APIGATEWAY_USERNAME = props['apigateway_username']?.trim()
          env.APIGATEWAY_PASSWORD = props['apigateway_password']?.trim()

          env.GIT_USER_NAME  = props['git_user_name']?.trim()
          env.GIT_USER_EMAIL = props['git_user_email']?.trim()

          env.COMMON_LIB_LOCATION = "${env.WORKSPACE}\\bin"

          echo "API_PROJECT=${env.API_PROJECT}"
          echo "APIGATEWAY_URL=${env.APIGATEWAY_URL}"
        }
      }
    }

    stage('Export API from Gateway') {
      steps {
        powershell '''
          Write-Host "Exporting API: $env:API_PROJECT"
          Write-Host "Gateway: $env:APIGATEWAY_URL"

          . "$env:COMMON_LIB_LOCATION\\common.ps1"

          Export-Api `
            -ApiProject $env:API_PROJECT `
            -Url        $env:APIGATEWAY_URL `
            -Username   $env:APIGATEWAY_USERNAME `
            -Password   $env:APIGATEWAY_PASSWORD
        '''
      }
    }

    stage('Git Commit & Push') {
      steps {
          powershell '''
            $ErrorActionPreference = "Stop"

            git config user.name  "$env:GIT_USER_NAME"
            git config user.email "$env:GIT_USER_EMAIL"

            git checkout -B main origin/main
            git pull origin main

            git add .

            try {
              git commit -m "auto: export API $env:API_PROJECT"
            } catch {
              Write-Host "No changes to commit"
            }

            git remote set-url origin git@github.com:ahmadhidayatt/asset-api-testcicd.git
            git push origin main

            exit 0
          '''
        
      }
    }
  }

  post {
    success {
      echo "EXPORT PIPELINE SUCCESS ✅"
    }
    failure {
      echo "EXPORT PIPELINE FAILED ❌"
    }
  }
}
